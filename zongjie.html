<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ‰‹å¹´åº¦æ€»ç»“ - SNAP Edition</title>
    <!-- å¼•å…¥åº“æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;600;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Oswald:wght@500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-header': '#D9825B', 
                        'brand-body': '#F6E4D6',   
                        'vintage-brown': '#5D4037', 
                        'classic-gold': '#C5A065',  
                        'warm-beige': '#F0ECE3',    
                        'warm-beige-dark': '#D8D0C5', 
                        'paper-white': '#fdfbf7',
                    },
                    fontFamily: {
                        'serif-sc': ['"Noto Serif SC"', 'serif'],
                        'playfair': ['"Playfair Display"', 'serif'],
                        'oswald': ['"Oswald"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f1f5f9;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* éšè—çš„æ¸²æŸ“åŒºåŸŸ (æš—æˆ¿) */
        #darkroom {
            position: fixed;
            left: -9999px;
            top: 0;
            pointer-events: none;
            opacity: 0; 
            z-index: -1;
        }

        /* æ‹ç«‹å¾—å¡ç‰‡å®¹å™¨ */
        #capture-target {
            padding: 40px; 
            background: transparent;
            width: 460px; 
            transform: translateZ(0);
        }

        /* æ‹ç«‹å¾—å¡ç‰‡æœ¬ä½“ */
        .polaroid-card {
            width: 380px;
            background-color: #fdfbf7; /* é»˜è®¤èƒŒæ™¯ï¼Œä¼šè¢«JSè¦†ç›– */
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2);
            padding: 24px 24px 50px 24px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.3s ease;
        }

        /* é¡¶éƒ¨å¤§èƒ¶å¸¦ (è£…é¥°ç”¨ï¼Œæ¸²æŸ“æ—¶ä¼šéšè—) */
        .tape-main {
            position: absolute;
            top: -15px; 
            left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            width: 140px;
            height: 35px;
            background-color: rgba(217, 119, 6, 0.4);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
            backdrop-filter: blur(2px);
            mask-image: linear-gradient(90deg, transparent 0%, black 2%, black 98%, transparent 100%);
            -webkit-mask-image: linear-gradient(90deg, transparent 0%, black 2%, black 98%, transparent 100%);
        }

        /* ----------------------- 
           ç…§ç‰‡å¢™ä¸Šçš„å…ƒç´ æ ·å¼ 
           ----------------------- */
        .gallery-wrapper {
            position: relative;
            width: 260px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        .gallery-wrapper:hover {
            transform: scale(1.1) rotate(0deg) !important;
            z-index: 100;
        }

        /* æ‚¬åœæ—¶æ˜¾ç¤ºçš„æŒ‰é’® */
        .gallery-wrapper:hover .download-btn-single,
        .gallery-wrapper:hover .delete-btn-single {
            opacity: 1;
            pointer-events: auto;
        }
        
        .gallery-wrapper:hover .download-btn-single {
            transform: translate(-50%, -50%) scale(1);
        }

        .gallery-image {
            width: 100%;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            display: block;
        }

        .gallery-wrapper:hover .gallery-image {
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.3));
        }

        .tape-on-board {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(-1deg);
            width: 100px;
            height: 25px;
            background-color: rgba(217, 119, 6, 0.45); 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 20;
            backdrop-filter: blur(1px);
        }

        .download-btn-single {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(154, 52, 18, 0.9);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none; 
            transition: all 0.2s ease;
            z-index: 30;
            border: 2px solid rgba(255,255,255,0.4);
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .download-btn-single:hover {
            background: #d97706;
            border-color: white;
            transform: translate(-50%, -50%) scale(1);
        }

        .delete-btn-single {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 40;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
        }
        .delete-btn-single:hover {
            background: #dc2626; 
            transform: scale(1.1);
        }

        .tape-gold {
            background-color: rgba(217, 119, 6, 0.5); 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            backdrop-filter: blur(1px);
        }

        .paper-scrap {
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.03);
            position: relative;
            transition: background-color 0.3s ease;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        /* å·¦ä¾§è¾“å…¥åŒºèƒŒæ™¯ */
        .input-sidebar {
            background-color: #F6E4D6; 
        }

        /* çº¯å‡€ç™½æ¿èƒŒæ™¯ */
        .cork-board {
            background-color: #F0ECE3;
            border-left: 8px solid #5D4037;
            position: relative;
        }

        /* ç›¸æœºç»„ä»¶ */
        .camera-container {
            position: absolute;
            top: 40px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 50; 
            perspective: 1000px;
            pointer-events: none;
        }

        .camera-body {
            width: 200px;
            height: 150px;
            background: linear-gradient(to bottom, #fdfbf7 0%, #e8e6e1 100%);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3), inset 0 -4px 0 rgba(0,0,0,0.1);
            position: relative;
            z-index: 20; 
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto; 
        }
        
        .rainbow-stripe {
            position: absolute;
            bottom: 25px;
            width: 100%;
            height: 10px;
            background: linear-gradient(to right, #ff3b30 0%, #ff3b30 20%, #ff9500 20%, #ff9500 40%, #ffcc00 40%, #ffcc00 60%, #4cd964 60%, #4cd964 80%, #007aff 80%, #007aff 100%);
            opacity: 0.9;
        }

        .lens-outer {
            width: 90px;
            height: 90px;
            background: #222;
            border-radius: 50%;
            border: 4px solid #d1d1d6;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        .lens-inner {
            width: 65px;
            height: 65px;
            background: radial-gradient(circle at 30% 30%, #444 0%, #111 60%, #000 100%);
            border-radius: 50%;
            border: 2px solid #333;
            position: relative;
        }
        
        .lens-reflection {
            position: absolute;
            top: 15px; left: 15px; width: 15px; height: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .viewfinder {
            position: absolute; top: 15px; left: 15px; width: 30px; height: 25px;
            background: #333; border-radius: 6px; border: 2px solid #ccc;
        }

        .flash {
            position: absolute; top: 15px; right: 15px; width: 40px; height: 25px;
            background: #eee; border-radius: 4px; border: 2px solid #ccc;
            background-image: radial-gradient(circle, #fff 10%, #ddd 90%);
            transition: all 0.1s;
        }
        
        .flash.firing {
            box-shadow: 0 0 50px 30px rgba(255, 255, 255, 1);
            background: #fff;
        }

        .shutter-btn {
            position: absolute; bottom: -4px; right: 25px; width: 32px; height: 32px;
            background: #ff3b30; border-radius: 50%; border: 3px solid #d1d1d6;
            box-shadow: 0 3px 0 #b3261e;
            z-index: 3;
        }

        .slot {
            position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            width: 160px; height: 10px;
            background: #111; border-radius: 0 0 10px 10px;
            z-index: 5;
        }

        .flying-photo {
            position: fixed; 
            width: 200px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform-origin: top center;
            transition: all 1s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .placeholder-item {
            width: 260px;
            height: 340px; 
            background: rgba(0,0,0,0.05);
            border: 2px dashed rgba(0,0,0,0.1);
            border-radius: 4px;
            visibility: hidden;
        }

        /* -----------------------
           é«˜çº§æŒ‰é’®æ ·å¼
           ----------------------- */
        .snap-btn {
            background: linear-gradient(135deg, #D9825B 0%, #A65D3B 100%);
            color: white;
            border: 2px solid #A65D3B;
            box-shadow: 
                0 4px 6px -1px rgba(93, 64, 55, 0.2), 
                0 2px 4px -1px rgba(93, 64, 55, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .snap-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 10px 15px -3px rgba(93, 64, 55, 0.3), 
                0 4px 6px -2px rgba(93, 64, 55, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: #D9825B;
        }

        .snap-btn:active {
            transform: translateY(1px);
        }

        .snap-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .snap-btn::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-25deg);
            transition: 0.5s;
        }
        
        .snap-btn:hover::after {
            left: 200%;
            transition: 0.7s ease-in-out;
        }

        /* é¢œè‰²é€‰æ‹©å™¨åœ†ç‚¹æ ·å¼ */
        .color-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent; /* é»˜è®¤é€æ˜è¾¹æ¡† */
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-dot:hover {
            transform: scale(1.1);
        }
        /* é€‰ä¸­çŠ¶æ€ï¼šåŒå±‚åœˆæ•ˆæœ */
        .color-dot.selected {
            border-color: #5D4037; /* æ·±æ‘©å¡è‰²å¤–è¾¹æ¡† */
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.8), 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* éšæœºæŒ‰é’®çš„æ¸å˜èƒŒæ™¯ */
        .random-dot-bg {
            background: linear-gradient(135deg, #fdfbf7 0%, #ffe4e6 20%, #dcfce7 40%, #e0f2fe 60%, #f3e8ff 80%, #f1f5f9 100%);
        }

    </style>
</head>
<body>

    <!-- å·¦ä¾§ï¼šè¾“å…¥æ§åˆ¶åŒº -->
    <div class="w-[400px] input-sidebar border-r border-[#D9825B] flex flex-col h-full z-20 shadow-2xl flex-shrink-0">
        <div class="p-8 bg-brand-header text-white relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-28 h-28 bg-white/20 rounded-full opacity-50 blur-xl"></div>
            <h1 class="text-3xl font-bold font-serif-sc tracking-widest relative z-10">æ–‡æ‰‹å¹´åº¦æ€»ç»“</h1>
            <p class="text-sm text-white/80 mt-2 font-serif-sc relative z-10 opacity-80 italic">Surprise Polaroid Edition</p>
        </div>
        
        <div class="flex-1 overflow-y-auto p-8 space-y-8">
            <div class="group">
                <label class="block text-xs font-bold text-[#5D4037] uppercase tracking-widest mb-3">Select Month</label>
                <div class="relative">
                    <select id="monthSelect" onchange="handleMonthChange()" class="w-full p-3 pl-4 border-2 border-[#D8D0C5] rounded-lg shadow-sm focus:ring-2 focus:ring-[#D9825B] focus:border-[#D9825B] bg-white/90 text-[#5D4037] appearance-none font-serif-sc font-bold text-lg">
                        <option value="1">ä¸€æœˆ (January)</option>
                        <option value="2">äºŒæœˆ (February)</option>
                        <option value="3">ä¸‰æœˆ (March)</option>
                        <option value="4">å››æœˆ (April)</option>
                        <option value="5">äº”æœˆ (May)</option>
                        <option value="6">å…­æœˆ (June)</option>
                        <option value="7">ä¸ƒæœˆ (July)</option>
                        <option value="8">å…«æœˆ (August)</option>
                        <option value="9">ä¹æœˆ (September)</option>
                        <option value="10">åæœˆ (October)</option>
                        <option value="11">åä¸€æœˆ (November)</option>
                        <option value="12">åäºŒæœˆ (December)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-[#5D4037]">
                        <svg class="h-5 w-5 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </div>
                </div>
            </div>

            <!-- é¢œè‰²é€‰æ‹©å™¨åŒºåŸŸ -->
            <div class="group">
                <label class="block text-xs font-bold text-[#5D4037] uppercase tracking-widest mb-3">Style Palette</label>
                <div class="flex flex-wrap gap-3 items-center" id="paletteSelector">
                    <!-- JS å°†åœ¨è¿™é‡Œæ’å…¥åœ†ç‚¹ -->
                </div>
            </div>

            <!-- è¾“å…¥æ¡†å®¹å™¨èƒŒæ™¯ -->
            <div id="januaryOnlyFields" class="space-y-4 bg-white/40 p-5 rounded-xl border border-[#D8D0C5] relative overflow-hidden shadow-sm">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-[#D9825B]"></div>
                <div class="text-xs text-[#D9825B] font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                    <span>âœ¨ Annual Settings</span>
                </div>
                <div>
                    <label class="block text-xs font-medium text-[#5D4037] mb-1">å¹´åº¦æ ‡é¢˜</label>
                    <input type="text" id="inputMainTitle" value="æ–‡æ‰‹å¹´åº¦æ€»ç»“" 
                           class="w-full p-2 border-b border-[#D8D0C5] bg-transparent focus:border-[#D9825B] focus:outline-none transition-colors text-base text-[#5D4037] placeholder-[#A69B95]" oninput="updatePreview()">
                </div>
                <div>
                    <label class="block text-xs font-medium text-[#5D4037] mb-1">å¡«è¡¨äºº</label>
                    <input type="text" id="inputFiller" placeholder="ä½ çš„ç¬”å" 
                           class="w-full p-2 border-b border-[#D8D0C5] bg-transparent focus:border-[#D9825B] focus:outline-none transition-colors text-base text-[#5D4037] placeholder-[#A69B95]" oninput="updatePreview()">
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-[#5D4037] uppercase tracking-widest mb-3">Content Input</label>
                    <div class="space-y-4">
                        <div>
                            <input type="text" id="inputWorkTitle" placeholder="æœ¬æœˆå†™ä½œæ ‡é¢˜" 
                                   class="w-full p-4 border-2 border-[#D8D0C5] bg-white/80 rounded-lg text-sm focus:ring-2 focus:ring-[#D9825B] focus:border-[#D9825B] shadow-sm transition-shadow hover:shadow-md text-[#5D4037] placeholder-[#A69B95]" oninput="updatePreview()">
                        </div>
                        <div>
                            <input type="text" id="inputCP" placeholder="CPå (å¯é€‰)" 
                                   class="w-full p-4 border-2 border-[#D8D0C5] bg-white/80 rounded-lg text-sm focus:ring-2 focus:ring-[#D9825B] focus:border-[#D9825B] shadow-sm transition-shadow hover:shadow-md text-[#5D4037] placeholder-[#A69B95]" oninput="updatePreview()">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-[#5D4037] mb-2">æœ€å–œæ¬¢çš„ç‰‡æ®µ</label>
                    <textarea id="inputSnippet" rows="6" placeholder="è¾“å…¥é‚£ä¸ªè®©ä½ å¿ƒåŠ¨çš„ç¬é—´..." 
                              class="w-full p-4 border-2 border-[#D8D0C5] bg-white/80 rounded-lg text-sm focus:ring-2 focus:ring-[#D9825B] focus:border-[#D9825B] leading-relaxed shadow-sm transition-shadow hover:shadow-md resize-none text-[#5D4037] placeholder-[#A69B95]" oninput="updatePreview()"></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-[#5D4037] mb-2">Free Talk</label>
                    <textarea id="inputFreeTalk" rows="3" placeholder="æœ¬æœˆçš„ä¸€ç‚¹ç¢ç¢å¿µ..." 
                              class="w-full p-4 border-2 border-[#D8D0C5] bg-white/80 rounded-lg text-sm focus:ring-2 focus:ring-[#D9825B] focus:border-[#D9825B] shadow-sm transition-shadow hover:shadow-md text-[#5D4037] placeholder-[#A69B95]" oninput="updatePreview()"></textarea>
                </div>
            </div>
        </div>

        <div class="p-6 border-t border-[#D8D0C5] bg-brand-body z-10">
            <button onclick="generateImage()" id="generateBtn" 
                    class="snap-btn w-full font-oswald font-bold py-4 px-4 rounded-xl flex items-center justify-center gap-3 text-2xl relative overflow-hidden">
                <span class="relative z-10">SNAP</span>
                <span class="text-sm relative z-10 opacity-70 font-normal normal-case ml-1 tracking-normal">ç”Ÿæˆæ‹ç«‹å¾—</span>
            </button>
            <p class="text-center text-xs text-[#5D4037]/70 mt-3 font-serif-sc">ç›¸æœºä¼šè‡ªåŠ¨æ‹ç…§å¹¶è´´åˆ°ç™½æ¿ä¸Š</p>
        </div>
    </div>

    <!-- éšè—çš„æš—æˆ¿åŒºåŸŸ -->
    <div id="darkroom">
        <div id="capture-target">
            <div id="polaroidCard" class="polaroid-card">
                <!-- è¿™é‡Œçš„ HTML å†…å®¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç™½æ¿å±•ç¤ºåŒº -->
    <div class="flex-1 cork-board flex flex-col h-full shadow-2xl relative z-10" id="boardExportArea">
        <div class="p-6 bg-[#F0ECE3]/90 backdrop-blur border-b border-[#D8D0C5] shadow-sm flex justify-between items-center z-[60] sticky top-0">
            <div class="flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-classic-gold shadow-lg ring-2 ring-white"></span>
                <h3 class="font-bold text-vintage-brown text-xl font-serif-sc">æˆ‘çš„å¹´åº¦ç™½æ¿</h3>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm font-bold text-[#5D4037] bg-white/80 px-3 py-1.5 rounded-full shadow-md border border-[#D8D0C5]" id="countBadge">0 å¼ </span>
                <!-- æ–°å¢æ‰“èµæŒ‰é’® -->
                <button onclick="toggleDonateModal()" class="text-sm font-bold bg-[#ec4899] text-white border border-[#db2777] px-3 py-1.5 rounded-full shadow-md hover:bg-[#db2777] transition-colors flex items-center gap-2">
                    <span>ğŸ¥¤</span> æˆ‘è¦æ‰“èµ
                </button>
                <button onclick="exportFullBoard()" class="text-sm font-bold bg-vintage-brown text-white border border-[#D9825B] px-3 py-1.5 rounded-full shadow-md hover:bg-[#D9825B] transition-colors flex items-center gap-2">
                    <span>ğŸ–¼ï¸</span> å¯¼å‡ºç™½æ¿é•¿å›¾
                </button>
                <button onclick="downloadAll()" id="downloadAllBtn" class="text-sm font-bold bg-white text-vintage-brown border border-[#D8D0C5] px-3 py-1.5 rounded-full shadow-md hover:bg-slate-50 transition-colors hidden">
                    ğŸ“¦ æ‰“åŒ…åŸå›¾ (ZIP)
                </button>
            </div>
        </div>
        
        <div id="galleryContainer" class="flex-1 overflow-y-auto p-12 pt-96 flex flex-wrap content-start gap-12 justify-center relative">
            <div class="camera-container" id="camera">
                <div class="camera-body">
                    <div class="viewfinder"></div>
                    <div class="flash" id="camFlash"></div>
                    <div class="rainbow-stripe"></div>
                    <div class="lens-outer">
                        <div class="lens-inner">
                            <div class="lens-reflection"></div>
                        </div>
                    </div>
                    <div class="slot"></div>
                    <div class="shutter-btn"></div>
                </div>
            </div>
            <div class="w-full flex flex-col items-center justify-center mt-12 text-[#5D4037] opacity-40 select-none pointer-events-none" id="emptyState">
                <div class="text-7xl mb-4 grayscale animate-pulse">ğŸ“·</div>
                <p class="text-lg font-serif-sc">åœ¨å·¦ä¾§è¾“å…¥ï¼Œç‚¹å‡» SNAP<br>å¡«æ»¡è¿™é¢å¢™</p>
            </div>
        </div>
    </div>

    <!-- Donation Modal -->
    <div id="donateModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm" onclick="toggleDonateModal()">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative transform transition-all scale-100" onclick="event.stopPropagation()">
            <button onclick="toggleDonateModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="mb-4 overflow-hidden rounded-xl border-2 border-orange-100">
                <!-- User's QR code image URL -->
                <img src="https://youke2.picui.cn/s1/2025/12/12/693c0d01e468c.jpg" alt="æŸ¥ç†ç™½èŠ±çŒ«çš„æ”¶æ¬¾ç " class="w-full h-auto object-cover">
            </div>
            <h3 class="text-xl font-bold text-[#5D4037] mb-2 font-serif-sc">ç»™å¼€å‘è€…ç‚¹æ¯å¥¶èŒ¶ ğŸ¥¤</h3>
            <p class="text-sm text-gray-600 leading-relaxed font-serif-sc">
                å¤§å®¶å¥½æˆ‘æ˜¯æŸ¥ç†ç™½èŠ±çŒ«ï¼Œå¦‚æœä½ å–œæ¬¢è¿™ä¸ªå°å·¥å…·çš„è¯ï¼Œå¯ä»¥è‡ªç”±æ‰“èµï½æœ¬ç½‘ç«™æ°¸ä¹…å…è´¹ã€ä¸æ¥å¹¿å‘Šã€‚
            </p>
        </div>
    </div>

    <script>
        // å®šä¹‰å…¨å±€å˜é‡å’Œå‡½æ•°
        const monthData = [
            { num: '01', name: 'JAN', cn: 'ä¸€æœˆ' }, { num: '02', name: 'FEB', cn: 'äºŒæœˆ' },
            { num: '03', name: 'MAR', cn: 'ä¸‰æœˆ' }, { num: '04', name: 'APR', cn: 'å››æœˆ' },
            { num: '05', name: 'MAY', cn: 'äº”æœˆ' }, { num: '06', name: 'JUN', cn: 'å…­æœˆ' },
            { num: '07', name: 'JUL', cn: 'ä¸ƒæœˆ' }, { num: '08', name: 'AUG', cn: 'å…«æœˆ' },
            { num: '09', name: 'SEP', cn: 'ä¹æœˆ' }, { num: '10', name: 'OCT', cn: 'åæœˆ' },
            { num: '11', name: 'NOV', cn: 'åä¸€æœˆ' }, { num: '12', name: 'DEC', cn: 'åäºŒæœˆ' }
        ];

        const palettes = [
            { name: "åŸæœ¨", bg: "#fdfbf7", text: "#5D4037", accent: "#C5A065", noteBg: "#fff", talkBg: "#fefce8", highlight: "#fef9c3" },
            { name: "è–„è·", bg: "#f0fdf4", text: "#14532d", accent: "#15803d", noteBg: "#fff", talkBg: "#dcfce7", highlight: "#dcfce7" },
            { name: "æµ·ç›", bg: "#f0f9ff", text: "#0c4a6e", accent: "#0284c7", noteBg: "#fff", talkBg: "#e0f2fe", highlight: "#e0f2fe" },
            { name: "æ¨±èŠ±", bg: "#fff1f2", text: "#881337", accent: "#e11d48", noteBg: "#fff", talkBg: "#ffe4e6", highlight: "#ffe4e6" },
            { name: "é¦™èŠ‹", bg: "#faf5ff", text: "#581c87", accent: "#9333ea", noteBg: "#fff", talkBg: "#f3e8ff", highlight: "#f3e8ff" },
            { name: "è¿·é›¾", bg: "#f8fafc", text: "#334155", accent: "#64748b", noteBg: "#fff", talkBg: "#f1f5f9", highlight: "#f1f5f9" }
        ];

        let generatedPhotos = []; 
        let isGenerating = false;
        let selectedPaletteIndex = -1;
        let db;

        // æ‰“èµå¼¹çª—åŠŸèƒ½
        function toggleDonateModal() {
            const modal = document.getElementById('donateModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        // --- æ¨¡æ¿æ¸²æŸ“é€»è¾‘ (ä»…ä¿ç•™ç»å…¸æ¨¡æ¿A) ---
        function renderCardContent() {
            const card = document.getElementById('polaroidCard');
            card.innerHTML = `
                <div class="tape-main" id="renderTape"></div>
                <div id="januaryHeader" class="mb-5 relative">
                    <div class="absolute -top-6 -right-4 text-7xl font-playfair font-black text-slate-200 select-none z-0 opacity-80 rotate-12">2025</div>
                    <div class="relative z-10 text-center">
                        <h2 id="viewMainTitle" class="text-4xl font-serif-sc font-bold text-vintage-brown tracking-wider mb-3 mt-4">æ–‡æ‰‹å¹´åº¦æ€»ç»“</h2>
                        <div class="inline-flex flex-col items-center">
                            <div class="py-1 px-5 flex items-center gap-2">
                                <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">WRITTEN BY</span>
                                <span class="font-serif-sc font-bold text-vintage-brown text-sm" id="viewFiller">NAME</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between mb-4 pb-2">
                    <div class="flex items-baseline gap-3">
                        <div class="text-4xl font-playfair font-black text-vintage-brown leading-none uppercase tracking-tight" id="viewMonthName">JAN</div>
                        <div class="h-6 w-[1px] bg-classic-gold rotate-12" id="viewDivider"></div>
                        <div class="text-lg font-serif-sc font-bold text-classic-gold leading-none" id="viewMonthCN">ä¸€æœˆ</div>
                    </div>
                    <div class="text-5xl font-playfair font-bold text-slate-100 select-none" id="viewMonthNum">01</div>
                </div>
                <div class="flex-1 flex flex-col gap-6 relative z-10">
                    <div class="flex flex-col gap-2 px-1">
                        <div class="flex items-baseline gap-2">
                            <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded uppercase tracking-wider min-w-fit">Title</span>
                            <span class="text-lg font-serif-sc font-bold text-vintage-brown w-full leading-tight" id="viewWorkTitle">æ— é¢˜</span>
                        </div>
                        <div class="flex items-center gap-2" id="viewCPRow">
                            <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded uppercase tracking-wider min-w-fit">CP</span>
                            <span class="px-2 py-0.5 rounded text-sm font-bold text-vintage-brown font-serif-sc" id="viewCP">---</span>
                        </div>
                    </div>
                    <div class="relative paper-scrap p-4 rotate-1 bg-white transform transition-transform" id="viewSnippetContainer">
                        <div id="viewSnippet" class="font-serif-sc text-slate-700 text-sm leading-7 text-justify whitespace-pre-wrap">ç­‰å¾…è¾“å…¥...</div>
                    </div>
                    <div class="mt-auto pt-2">
                         <div class="relative paper-scrap p-3 bg-yellow-50 -rotate-1 transform transition-transform" id="viewFreeTalkContainer">
                             <div class="absolute -top-2.5 left-1/2 -translate-x-1/2 w-8 h-4 tape-gold -rotate-2 z-10"></div>
                             <div class="text-[10px] font-bold text-classic-gold uppercase tracking-wider mb-1" id="viewFreeTalkLabel">Free Talk</div>
                             <div id="viewFreeTalk" class="text-xs text-slate-600 leading-relaxed font-serif-sc relative z-10">...</div>
                         </div>
                    </div>
                </div>
                <div class="absolute bottom-3 right-6">
                    <span class="text-[10px] text-slate-300 font-playfair italic">Writer's Log</span>
                </div>
            `;
            
            updatePreview(); 
            if (selectedPaletteIndex !== -1) {
                applyPalette(palettes[selectedPaletteIndex]);
            } else {
                applyPalette(palettes[0]);
            }
        }

        // åˆå§‹åŒ–å‡½æ•°
        window.onload = async function() {
            renderCardContent(); // åˆå§‹åŒ–å¡ç‰‡å†…å®¹
            handleMonthChange();
            renderPaletteSelector();
            
            try {
                await initDB();
                await loadPhotosFromDB();
            } catch (e) {
                console.log("DB Init failed (likely private mode or sandboxed iframe):", e);
            }
        };

        // IndexedDB ç›¸å…³å‡½æ•°
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("WriterSummaryPolaroidDB", 1);
                request.onerror = (event) => reject(event.target.error);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("photos")) db.createObjectStore("photos", { keyPath: "id" });
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
            });
        }

        async function loadPhotosFromDB() {
            if (!db) return;
            return new Promise((resolve) => {
                const transaction = db.transaction(["photos"], "readonly");
                const store = transaction.objectStore("photos");
                store.getAll().onsuccess = (event) => {
                    event.target.result.forEach(photo => {
                        generatedPhotos.push(photo);
                        renderPhotoToGallery(photo, false);
                    });
                    updateCount();
                    if(generatedPhotos.length > 0) document.getElementById('emptyState').style.display = 'none';
                    resolve();
                };
            });
        }

        function savePhotoToDB(photo) {
            if (!db) return;
            db.transaction(["photos"], "readwrite").objectStore("photos").add(photo);
        }

        function deletePhotoFromDB(id) {
            if (!db) return;
            db.transaction(["photos"], "readwrite").objectStore("photos").delete(id);
        }

        // é¢œè‰²é€‰æ‹©å™¨é€»è¾‘
        function renderPaletteSelector() {
            const container = document.getElementById('paletteSelector');
            container.innerHTML = '';
            const randomBtn = document.createElement('div');
            randomBtn.className = 'color-dot random-dot-bg selected';
            randomBtn.title = "éšæœºé…è‰²";
            randomBtn.innerHTML = '<span class="flex items-center justify-center w-full h-full text-[10px] text-gray-500 font-bold">?</span>';
            randomBtn.onclick = () => selectPalette(-1, randomBtn);
            container.appendChild(randomBtn);
            palettes.forEach((palette, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-dot';
                btn.title = palette.name;
                btn.style.backgroundColor = palette.bg;
                btn.style.borderColor = palette.accent;
                btn.onclick = () => selectPalette(index, btn);
                container.appendChild(btn);
            });
        }

        function selectPalette(index, clickedBtn) {
            selectedPaletteIndex = index;
            document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('selected'));
            clickedBtn.classList.add('selected');
            if (index !== -1) applyPalette(palettes[index]);
        }

        function applyPalette(palette) {
            const card = document.getElementById('polaroidCard');
            card.style.backgroundColor = palette.bg;

            ['viewMainTitle', 'viewFiller', 'viewWorkTitle', 'viewMonthName'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.color = palette.text;
            });

            ['viewMonthCN', 'viewFreeTalkLabel'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.color = palette.accent;
            });
            const divider = document.getElementById('viewDivider');
            if(divider) divider.style.backgroundColor = palette.accent;

            const freeTalkContainer = document.getElementById('viewFreeTalkContainer');
            if(freeTalkContainer) {
                freeTalkContainer.style.backgroundColor = palette.talkBg;
                freeTalkContainer.style.borderLeft = 'none';
            }
            
            const freeTalkLabel = document.getElementById('viewFreeTalkLabel');
            if(freeTalkLabel) freeTalkLabel.style.color = palette.accent;

            const snippetContainer = document.getElementById('viewSnippetContainer');
            if(snippetContainer) {
                snippetContainer.style.backgroundColor = palette.noteBg;
            }

            const cpEl = document.getElementById('viewCP');
            if (cpEl) {
                cpEl.style.backgroundColor = palette.highlight;
                cpEl.style.color = palette.text;
            }
        }

        function handleMonthChange() {
            const select = document.getElementById('monthSelect');
            const data = monthData[parseInt(select.value) - 1];
            
            const mNum = document.getElementById('viewMonthNum');
            if(mNum) mNum.textContent = data.num;
            const mName = document.getElementById('viewMonthName');
            if(mName) mName.textContent = data.name;
            const mCN = document.getElementById('viewMonthCN');
            if(mCN) mCN.textContent = data.cn;
            
            const janFields = document.getElementById('januaryOnlyFields');
            const janHeader = document.getElementById('januaryHeader');
            const isJan = data.num === '01';
            
            if (janFields) janFields.classList.toggle('hidden', !isJan);
            if (janHeader) janHeader.style.display = isJan ? 'block' : 'none';
            
            updatePreview();
        }

        function updatePreview() {
            const mainTitle = document.getElementById('inputMainTitle').value || 'æ–‡æ‰‹å¹´åº¦æ€»ç»“';
            const filler = document.getElementById('inputFiller').value || '---';
            const workTitle = document.getElementById('inputWorkTitle').value || 'æ— é¢˜';
            const cpVal = document.getElementById('inputCP').value.trim();
            const snippet = document.getElementById('inputSnippet').value || 'ï¼ˆç­‰å¾…ç”Ÿæˆ...ï¼‰';
            const freeTalk = document.getElementById('inputFreeTalk').value || '...';

            const elMainTitle = document.getElementById('viewMainTitle');
            if(elMainTitle) elMainTitle.textContent = mainTitle;
            
            const elFiller = document.getElementById('viewFiller');
            if(elFiller) elFiller.textContent = filler.toUpperCase();
            
            const elWorkTitle = document.getElementById('viewWorkTitle');
            if(elWorkTitle) elWorkTitle.textContent = workTitle;
            
            const cpRow = document.getElementById('viewCPRow');
            if (cpRow) {
                if (cpVal) {
                    cpRow.style.display = 'flex';
                    document.getElementById('viewCP').textContent = cpVal;
                } else {
                    cpRow.style.display = 'none';
                }
            }

            const elSnippet = document.getElementById('viewSnippet');
            if(elSnippet) elSnippet.textContent = snippet;
            
            const elFreeTalk = document.getElementById('viewFreeTalk');
            if(elFreeTalk) elFreeTalk.textContent = freeTalk;
        }

        function generateImage() {
            if (isGenerating) return;
            isGenerating = true;

            if (selectedPaletteIndex === -1) {
                applyPalette(palettes[Math.floor(Math.random() * palettes.length)]);
            } else {
                applyPalette(palettes[selectedPaletteIndex]);
            }

            const monthVal = parseInt(document.getElementById('monthSelect').value);
            const target = document.getElementById('polaroidCard'); 
            const gallery = document.getElementById('galleryContainer');
            const btn = document.getElementById('generateBtn');
            const camFlash = document.getElementById('camFlash');
            
            const renderTape = document.getElementById('renderTape');
            if(renderTape) renderTape.style.display = 'none';

            btn.disabled = true;
            btn.classList.add('opacity-75');

            camFlash.classList.add('firing');
            setTimeout(() => camFlash.classList.remove('firing'), 200);

            setTimeout(() => {
                html2canvas(target, {
                    scale: 6,
                    backgroundColor: null, 
                    logging: false,
                    useCORS: true,
                    onclone: (clonedDoc) => {
                        const clonedCard = clonedDoc.querySelector('.polaroid-card');
                        if(clonedCard) clonedCard.style.boxShadow = 'none';
                    }
                }).then(canvas => {
                    if(renderTape) renderTape.style.display = 'block';
                    document.getElementById('emptyState').style.display = 'none';

                    const imgData = canvas.toDataURL('image/png');
                    const photoId = Date.now() + Math.random(); 
                    
                    const photoObj = {
                        id: photoId,
                        monthIdx: monthVal,
                        data: imgData
                    };
                    
                    generatedPhotos.push(photoObj);
                    savePhotoToDB(photoObj);

                    // Animation logic
                    const flyingImg = document.createElement('img');
                    flyingImg.src = imgData;
                    flyingImg.className = 'flying-photo';
                    
                    const cameraEl = document.getElementById('camera');
                    const camRect = cameraEl.getBoundingClientRect();

                    const startTop = camRect.bottom - 20; 
                    const startLeft = camRect.left + (camRect.width / 2) - 100;

                    flyingImg.style.top = `${startTop}px`;
                    flyingImg.style.left = `${startLeft}px`;
                    flyingImg.style.transform = 'scale(0.8)';
                    
                    document.body.appendChild(flyingImg);

                    void flyingImg.offsetWidth;
                    flyingImg.style.transition = 'top 1.5s ease-out';
                    flyingImg.style.top = `${startTop + 200}px`;

                    setTimeout(() => {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder-item';
                        gallery.appendChild(placeholder);
                        gallery.scrollTop = gallery.scrollHeight;
                        const targetRect = placeholder.getBoundingClientRect();

                        flyingImg.style.transition = 'all 1.0s cubic-bezier(0.25, 1, 0.5, 1)';
                        flyingImg.style.top = `${targetRect.top}px`;
                        flyingImg.style.left = `${targetRect.left}px`;
                        flyingImg.style.width = `${targetRect.width}px`;
                        
                        const randomRotate = Math.random() * 6 - 3;
                        flyingImg.style.transform = `scale(1) rotate(${randomRotate}deg)`;

                        setTimeout(() => {
                            renderPhotoToGallery(photoObj, false); 
                            placeholder.remove();
                            flyingImg.remove();
                            updateCount();
                            isGenerating = false;
                            btn.disabled = false;
                            btn.classList.remove('opacity-75');
                        }, 1000); 
                    }, 1600); 
                });
            }, 100); 
        }

        function renderPhotoToGallery(photoObj, animate) {
            const gallery = document.getElementById('galleryContainer');
            const wrapper = document.createElement('div');
            wrapper.className = 'gallery-wrapper';
            wrapper.style.transform = `rotate(${Math.random() * 6 - 3}deg)`;
            wrapper.dataset.photoId = photoObj.id; 

            const tape = document.createElement('div');
            tape.className = 'tape-on-board';
            const img = new Image();
            img.src = photoObj.data;
            img.className = 'gallery-image';
            
            const dlBtn = document.createElement('button');
            dlBtn.className = 'download-btn-single';
            dlBtn.innerHTML = 'â¬‡';
            dlBtn.title = 'ä¸‹è½½åŸå›¾';
            dlBtn.onclick = (e) => { e.stopPropagation(); downloadPhoto(photoObj.id); };

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn-single';
            delBtn.innerHTML = 'Ã—'; 
            delBtn.title = 'åˆ é™¤ç…§ç‰‡';
            delBtn.onclick = (e) => { e.stopPropagation(); deletePhoto(photoObj.id, wrapper); };

            wrapper.appendChild(tape);
            wrapper.appendChild(img);
            wrapper.appendChild(dlBtn);
            wrapper.appendChild(delBtn);
            gallery.appendChild(wrapper);
        }

        function deletePhoto(id, element) {
            if (element) element.remove();
            generatedPhotos = generatedPhotos.filter(p => p.id !== id);
            deletePhotoFromDB(id);
            updateCount();
            if (generatedPhotos.length === 0) document.getElementById('emptyState').style.display = 'flex';
        }

        function updateCount() {
            const count = generatedPhotos.length;
            document.getElementById('countBadge').textContent = `${count} å¼ `;
            const dlAllBtn = document.getElementById('downloadAllBtn');
            if (count > 0) dlAllBtn.classList.remove('hidden'); else dlAllBtn.classList.add('hidden');
        }

        function downloadPhoto(id) {
            const item = generatedPhotos.find(p => p.id === id);
            if (!item) return;
            const link = document.createElement('a');
            link.href = item.data;
            link.download = `Summary2025_${monthData[item.monthIdx-1].name}_${Date.now()}.png`;
            link.click();
        }

        function downloadAll() {
            if (generatedPhotos.length === 0) return;
            const zip = new JSZip();
            generatedPhotos.forEach((item, index) => {
                const base64Data = item.data.replace(/^data:image\/(png|jpg);base64,/, "");
                zip.file(`Summary2025_${monthData[item.monthIdx-1].name}_${index+1}.png`, base64Data, {base64: true});
            });
            zip.generateAsync({type:"blob"}).then(content => saveAs(content, "WriterSummary2025_Polaroids.zip"));
        }

        function exportFullBoard() {
            const gallery = document.getElementById('galleryContainer');
            const fillerName = document.getElementById('inputFiller').value || 'Writer';
            const fullHeight = gallery.scrollHeight;
            const fullWidth = gallery.scrollWidth;

            html2canvas(gallery, {
                height: fullHeight, width: fullWidth, windowHeight: fullHeight, scale: 8, useCORS: true, backgroundColor: '#F0ECE3', 
                onclone: (clonedDoc) => {
                    const clonedGallery = clonedDoc.getElementById('galleryContainer');
                    clonedGallery.style.height = fullHeight + 'px';
                    clonedGallery.style.overflow = 'visible';
                    const clonedCamera = clonedDoc.getElementById('camera');
                    clonedCamera.style.position = 'absolute'; 

                    const headerGroup = clonedDoc.createElement('div');
                    headerGroup.style.position = 'absolute';
                    headerGroup.style.width = '100%';
                    headerGroup.style.textAlign = 'center';
                    headerGroup.style.top = '240px'; 
                    headerGroup.style.zIndex = '40';
                    headerGroup.style.display = 'flex';
                    headerGroup.style.flexDirection = 'column';
                    headerGroup.style.alignItems = 'center';
                    headerGroup.style.gap = '8px';

                    const title = clonedDoc.createElement('div');
                    title.innerText = 'æˆ‘çš„å¹´åº¦æ€»ç»“ç™½æ¿';
                    title.style.fontFamily = '"Noto Serif SC", serif';
                    title.style.fontSize = '48px';
                    title.style.fontWeight = '900'; 
                    title.style.color = '#5D4037'; 
                    
                    const subtitle = clonedDoc.createElement('div');
                    subtitle.innerHTML = `<span style="font-family: 'Playfair Display', serif; font-style: italic; color: #9a3412; font-size: 18px; margin-right: 8px;">Written by</span><span style="font-family: 'Noto Serif SC', serif; font-weight: bold; color: #D9825B; font-size: 24px;">${fillerName}</span>`;

                    headerGroup.appendChild(title);
                    headerGroup.appendChild(subtitle);
                    clonedGallery.appendChild(headerGroup);
                }
            }).then(canvas => {
                canvas.toBlob(function(blob) {
                    saveAs(blob, "My2025_Writer_Board.png");
                });
            });
        }
    </script>
</body>
</html>
